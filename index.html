<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local IPTV</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#d4af37">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f5f5, #e5e5e5);
      padding: 20px;
      text-align: center;
      direction: rtl;
    }
    h1 {
      color: #333;
      font-weight: 700;
    }
    marquee {
      font-size: 1.1em;
      color: #444;
      margin-bottom: 20px;
    }
    .input-row {
      margin: 10px auto;
      max-width: 300px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .input-row label {
      width: 35%;
      text-align: right;
      font-weight: bold;
    }
    .input-row input {
      width: 60%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: left;
      direction: ltr;
    }
    #toggleEdit, #manageCategoriesBtn, #saveCategoriesBtn {
      margin: 15px auto;
      padding: 12px 25px;
      background-color: #d4af37;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: background-color 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #toggleEdit.editing, #saveCategoriesBtn {
      background-color: #28a745;
    }
    #toggleEdit:not(.editing):hover, #manageCategoriesBtn:hover {
      background-color: #b8912a;
    }
    .section {
      margin-top: 30px;
    }
    .section h3 {
      border-bottom: 2px solid #d4af37;
      padding-bottom: 5px;
      display: inline-block;
      font-weight: 700;
      color: #333;
    }
    #favorites-container, #downloads-container {
      gap: 5px;
      padding: 10px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    #channels {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      padding: 10px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .channel-btn {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px 8px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8em;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s, transform 0.2s;
      color: #333;
      min-height: 36px;
    }
    .channel-btn:hover {
      background-color: #e0e0e0;
      transform: translateY(-2px);
    }
    .channel-btn .fav-icon {
      font-size: 1em;
      cursor: pointer;
      color: #fff;
      text-shadow: 0 0 2px #555;
      position: absolute;
      left: 5px;
      top: 5px;
      transform: none;
      display: block;
      z-index: 10;
    }
    .channel-btn.favorite .fav-icon {
      color: #dc3545;
      text-shadow: 0 0 2px #555;
    }
    .channel-btn span.channel-number,
    .channel-btn span.channel-name {
        flex-grow: 1;
        text-align: center;
        padding: 0;
        pointer-events: none;
        user-select: none;
    }
    .channel-btn.editing {
      justify-content: flex-end;
      padding: 5px 10px;
      text-align: right;
    }
    .channel-btn.editing .fav-icon {
      position: static;
      transform: none;
      margin-left: 5px;
      display: block;
      color: #fff;
      text-shadow: 0 0 2px #555;
    }
    .channel-btn.editing span.channel-name {
        pointer-events: auto;
        user-select: text;
        text-align: right;
        border-bottom: 1px dashed #000;
        display: inline;
        background-color: #e0e0e0;
        padding: 2px 6px;
        border-radius: 4px;
        max-width: 100%;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      direction: rtl;
    }
    .channel-btn.editing span.channel-number {
        display: none;
    }
    .search-row {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    #searchInput {
      width: 70%;
      max-width: 400px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: right;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .pagination button {
      padding: 10px 15px;
      background-color: #d4af37;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: background-color 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .pagination button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .pagination button:not(:disabled):hover {
      background-color: #b8912a;
    }
    .favorites-btn, .downloads-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .downloads-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .clear-downloads-btn {
        margin-top: 10px;
        padding: 8px 15px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.8em;
        transition: background-color 0.3s;
    }
    .clear-downloads-btn:hover {
        background-color: #c82333;
    }
    .downloads-btn.editing .delete-icon {
        display: block;
    }
    .downloads-btn .delete-icon {
        color: #dc3545;
        font-size: 1.2em;
        cursor: pointer;
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        display: none;
    }
    #instruction-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #333;
      color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
      font-size: 1.1em;
      line-height: 1.5;
      max-width: 300px;
      text-align: center;
    }
    .favorite-category {
        margin-bottom: 10px;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .category-header {
        cursor: pointer;
        padding: 10px 15px;
        background-color: #d4af37;
        color: white;
        margin: 0;
        display: flex;
        align-items: center;
        font-weight: bold;
    }
    .category-header:hover {
        background-color: #b8912a;
    }
    .category-channels {
        display: none;
        padding: 10px;
        grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        gap: 5px;
    }
    .category-channels.expanded {
        display: grid;
    }
    #favorites-section h3 {
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-bottom: 15px;
    }
    .favorite-options-modal {
        position: fixed; /* ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ fixed */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        padding: 15px;
        text-align: right;
        display: none;
        flex-direction: column;
        gap: 8px;
        min-width: 250px; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© */
        max-width: 80%;
    }
    .favorite-options-modal h4 {
        margin: 0 0 10px;
        color: #333;
        font-size: 1em;
        font-weight: bold;
    }
    .favorite-options-modal button {
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .favorite-options-modal button:hover {
        background-color: #e0e0e0;
    }
    .favorite-options-modal button.remove-fav {
        background-color: #dc3545;
        color: white;
    }
    .category-edit-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f0f0f0;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 5px;
    }
    .category-edit-container span {
        flex-grow: 1;
        text-align: right;
        padding: 0 5px;
        font-weight: 500;
        color: #333;
    }
    .category-edit-container input {
        flex-grow: 1;
        text-align: right;
        border: none;
        background-color: transparent;
        padding: 0 5px;
    }
    .category-edit-container .edit-icons {
        display: flex;
        gap: 5px;
    }
    .category-edit-container .edit-icons button {
        padding: 5px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1em;
        color: #dc3545;
    }
    .category-edit-container .edit-icons .edit-icon {
        color: #333;
    }
    .add-category-btn {
        width: 100%;
        padding: 10px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }
  </style>
</head>
<body>
  <h1>ğŸ“º Local IPTV</h1>
  <marquee behavior="scroll" direction="left">Mahmoud Adel Saleh ğŸ“º Local IPTV</marquee>

  <div class="input-row">
    <label for="ip">Ø¹Ù†ÙˆØ§Ù† IP:</label>
    <input type="text" id="ip" value="192.168.1.88">
  </div>
  <div class="input-row">
    <label for="port">Ø§Ù„Ø¨ÙˆØ±Øª:</label>
    <input type="text" id="port" value="9891">
  </div>

  <div class="section" id="favorites-section">
    <h3 onclick="toggleFavoritesSection()">ğŸ“Œ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3>
    <div id="favorites-container">
      <div id="favorites-controls">
        <button id="manageCategoriesBtn" onclick="toggleCategoryManagementMode()">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</button>
      </div>
    </div>
    <div class="favorite-options-modal" id="favoriteOptionsModal"></div>
  </div>

  <div class="section" id="downloads-section">
    <h3>ğŸ“¥ ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h3>
    <div class="downloads-container">
      <div id="download-channels"></div>
      <button class="clear-downloads-btn" onclick="clearDownloads()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
    </div>
  </div>

  <div id="instruction-message">
    ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù! <br>
    Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ØŒ <br>
    Ø«Ù… Ø§Ø®ØªØ± "Ø§Ù„ÙØªØ­ ÙÙŠ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¢Ø®Ø±" Ù„ØªØ´ØºÙŠÙ„Ù‡.
  </div>

  <div class="section" id="all-section">
    <h3>ğŸ“¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h3>
    <div class="search-row">
        <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø©...">
    </div>
    <button id="toggleEdit" onclick="toggleEditing()">âœï¸ ØªÙØ¹ÙŠÙ„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚Ù†ÙˆØ§Øª</button>
    <div class="pagination">
      <button onclick="goToFirstPage()" id="firstPageBtn">Ø§Ù„Ø£ÙˆÙ„</button>
      <button onclick="goToPreviousPage()" id="prevPageBtn">Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù¥Ù </button>
      <button onclick="goToNextPage()" id="nextPageBtn">Ø§Ù„ØªØ§Ù„ÙŠ Ù¥Ù </button>
      <button onclick="goToLastPage()" id="lastPageBtn">Ø§Ù„Ø£Ø®ÙŠØ±</button>
    </div>
    <div id="channels"></div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('Service Worker registered! Scope is:', registration.scope);
          })
          .catch(err => {
            console.log('Service Worker registration failed:', err);
          });
      });
    }

    let editingEnabled = false;
    let categoryManagementMode = false;
    let currentPage = 1;
    const channelsPerPage = 50;
    const maxChannels = 2000;
    const totalPages = Math.ceil(maxChannels / channelsPerPage);
    let favorites = JSON.parse(localStorage.getItem('favorites')) || {
        "Ø¯ÙŠÙ†ÙŠØ©": [],
        "Ø£Ø·ÙØ§Ù„": [],
        "ØªØ¹Ù„ÙŠÙ…ÙŠØ©": [],
        "Ø¥Ø®Ø¨Ø§Ø±ÙŠØ©": [],
        "Ø±ÙŠØ§Ø¶ÙŠØ©": [],
        "ÙˆØ«Ø§Ø¦Ù‚ÙŠØ©": [],
        "Ù…Ù†ÙˆØ¹Ø§Øª Ø¹Ø±Ø¨ÙŠØ©": [],
        "Ù…Ù†ÙˆØ¹Ø§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©": []
    };
    let downloadHistory = JSON.parse(localStorage.getItem('downloadHistory')) || [];

    const favoritesContainer = document.getElementById('favorites-container');
    const allChannelsContainer = document.getElementById('channels');
    const searchInput = document.getElementById('searchInput');
    const downloadsContainer = document.getElementById('download-channels');
    const instructionMessage = document.getElementById('instruction-message');
    const favoriteOptionsModal = document.getElementById('favoriteOptionsModal');

    function createChannelButton(number) {
      const btn = document.createElement('div');
      btn.className = 'channel-btn';
      btn.dataset.channelNumber = number;

      const favIcon = document.createElement('span');
      favIcon.className = 'fav-icon';
      favIcon.innerHTML = 'ğŸ¤';
      favIcon.onclick = (e) => {
        e.stopPropagation();
        toggleFavorite(number);
      };
      
      const channelNumberSpan = document.createElement('span');
      channelNumberSpan.className = 'channel-number';
      channelNumberSpan.textContent = number;

      const channelNameSpan = document.createElement('span');
      channelNameSpan.className = 'channel-name';
      const channelName = localStorage.getItem(`channelName_${number}`) || `Ù‚Ù†Ø§Ø© ${number}`;
      channelNameSpan.textContent = channelName;
      channelNameSpan.contentEditable = editingEnabled ? "true" : "false";
      channelNameSpan.setAttribute('aria-label', 'Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©');

      if (editingEnabled) {
        channelNameSpan.addEventListener('input', () => {
          localStorage.setItem(`channelName_${number}`, channelNameSpan.textContent);
          renderFavorites();
          renderDownloads();
        });
      }
      
      btn.appendChild(favIcon);
      if (editingEnabled) {
          btn.classList.add('editing');
          btn.appendChild(channelNameSpan);
      } else {
          btn.appendChild(channelNumberSpan);
          if (channelName !== `Ù‚Ù†Ø§Ø© ${number}`) {
              const nameText = document.createElement('span');
              nameText.textContent = channelName;
              nameText.style.fontSize = '0.7em';
              nameText.style.display = 'block';
              nameText.style.marginTop = '2px';
              btn.appendChild(nameText);
          }
      }

      btn.onclick = () => {
        if (!editingEnabled) {
          downloadM3U(number);
        }
      };
      
      if (isFavorite(number)) {
        btn.classList.add('favorite');
        favIcon.innerHTML = 'â¤ï¸';
      }

      return btn;
    }

    function createFavoriteButton(number, category) {
      const btn = document.createElement('div');
      btn.className = 'channel-btn favorites-btn';
      btn.dataset.channelNumber = number;

      const name = localStorage.getItem(`channelName_${number}`) || `Ù‚Ù†Ø§Ø© ${number}`;
      const nameSpan = document.createElement('span');
      nameSpan.style.fontSize = '0.8em';
      nameSpan.textContent = name;
      btn.appendChild(nameSpan);

      const favIcon = document.createElement('span');
      favIcon.className = 'fav-icon';
      favIcon.innerHTML = 'â¤ï¸';
      favIcon.onclick = (e) => {
          e.stopPropagation();
          removeFavorite(number, category);
      };
      btn.appendChild(favIcon);

      btn.onclick = () => {
        downloadM3U(number);
      };
      return btn;
    }

    function createDownloadButton(number) {
      const btn = document.createElement('div');
      btn.className = 'channel-btn downloads-btn';
      btn.dataset.channelNumber = number;

      const channelNumberSpan = document.createElement('span');
      channelNumberSpan.textContent = number;
      btn.appendChild(channelNumberSpan);

      if (editingEnabled) {
        btn.classList.add('editing');
        const deleteIcon = document.createElement('span');
        deleteIcon.className = 'delete-icon';
        deleteIcon.innerHTML = 'ğŸ—‘ï¸';
        deleteIcon.onclick = (e) => {
            e.stopPropagation();
            deleteChannelPermanently(number);
        };
        btn.appendChild(deleteIcon);
      }

      btn.onclick = () => {
        if (!editingEnabled) {
            downloadM3U(number);
        }
      };
      return btn;
    }
    
    function toggleFavoritesSection() {
        const contentDivs = document.querySelectorAll('#favorites-container > div');
        contentDivs.forEach(div => {
            if (div.id !== 'favorites-controls') {
                div.style.display = div.style.display === 'none' ? 'block' : 'none';
            }
        });
    }

    function toggleFavorite(number) {
        if (editingEnabled) return;
        
        favoriteOptionsModal.innerHTML = '';
        const isCurrentlyFavorite = isFavorite(number);

        if (isCurrentlyFavorite) {
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-fav';
            removeBtn.textContent = 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©';
            removeBtn.onclick = () => {
                for (const category in favorites) {
                    removeFavorite(number, category);
                }
                updateFavIcon(number, false);
                favoriteOptionsModal.style.display = 'none';
            };
            favoriteOptionsModal.appendChild(removeBtn);
        }

        const categoriesTitle = document.createElement('h4');
        categoriesTitle.textContent = isCurrentlyFavorite ? 'Ø£Ùˆ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ÙØ¦Ø© Ø£Ø®Ø±Ù‰:' : 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ ÙØ¦Ø©:';
        favoriteOptionsModal.appendChild(categoriesTitle);

        for (const category in favorites) {
            const categoryBtn = document.createElement('button');
            categoryBtn.textContent = category;
            categoryBtn.onclick = () => {
                if (isCurrentlyFavorite) {
                    for (const cat in favorites) {
                        removeFavorite(number, cat, false);
                    }
                }
                addChannelToCategory(number, category);
                updateFavIcon(number, true);
                favoriteOptionsModal.style.display = 'none';
            };
            favoriteOptionsModal.appendChild(categoryBtn);
        }
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';
        closeBtn.onclick = () => favoriteOptionsModal.style.display = 'none';
        favoriteOptionsModal.appendChild(closeBtn);

        favoriteOptionsModal.style.display = 'flex';
    }
    
    function updateFavIcon(number, isFav) {
        const btn = document.querySelector(`.channel-btn[data-channel-number="${number}"]`);
        if (btn) {
            const favIconElement = btn.querySelector('.fav-icon');
            if (isFav) {
                btn.classList.add('favorite');
                favIconElement.innerHTML = 'â¤ï¸';
            } else {
                btn.classList.remove('favorite');
                favIconElement.innerHTML = 'ğŸ¤';
            }
        }
    }

    function addChannelToCategory(number, category) {
        if (favorites[category] && !favorites[category].includes(number)) {
            favorites[category].push(number);
            favorites[category].sort((a,b)=>a-b);
            saveFavorites();
            renderFavorites();
        }
    }
    
    function removeFavorite(number, category, reRender = true) {
        const index = favorites[category].indexOf(number);
        if (index > -1) {
            favorites[category].splice(index, 1);
            saveFavorites();
            if (reRender) {
                renderFavorites();
                renderAllChannels(currentPage);
            }
        }
    }
    
    function isFavorite(number) {
        for (const category in favorites) {
            if (favorites[category].includes(number)) {
                return true;
            }
        }
        return false;
    }

    function saveFavorites() {
      localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    function saveDownloadHistory() {
      localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
    }

    function renderFavorites() {
      favoritesContainer.innerHTML = '';

      const controlsDiv = document.createElement('div');
      controlsDiv.id = 'favorites-controls';
      const manageBtn = document.createElement('button');
      manageBtn.id = 'manageCategoriesBtn';
      manageBtn.textContent = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª';
      manageBtn.onclick = toggleCategoryManagementMode;
      controlsDiv.appendChild(manageBtn);
      favoritesContainer.appendChild(controlsDiv);

      if (categoryManagementMode) {
          renderCategoryManagement();
      } else {
          for (const category in favorites) {
            if (favorites[category].length > 0) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'favorite-category';
                
                const categoryHeader = document.createElement('h4');
                categoryHeader.className = 'category-header';
                categoryHeader.textContent = `â–¶ï¸ ${category}`;
                categoryHeader.onclick = () => {
                    channelsContainer.classList.toggle('expanded');
                    if(channelsContainer.classList.contains('expanded')) {
                        categoryHeader.textContent = `ğŸ”½ ${category}`;
                    } else {
                        categoryHeader.textContent = `â–¶ï¸ ${category}`;
                    }
                };
                categoryDiv.appendChild(categoryHeader);

                const channelsContainer = document.createElement('div');
                channelsContainer.className = 'category-channels';
                categoryDiv.appendChild(channelsContainer);

                favorites[category].sort((a, b) => a - b).forEach(num => {
                    const btn = createFavoriteButton(num, category);
                    channelsContainer.appendChild(btn);
                });
                
                favoritesContainer.appendChild(categoryDiv);
            }
          }
      }
    }
    
    function toggleCategoryManagementMode() {
        categoryManagementMode = !categoryManagementMode;
        const manageBtn = document.getElementById('manageCategoriesBtn');
        if (categoryManagementMode) {
            manageBtn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø§Øª';
            manageBtn.style.backgroundColor = '#28a745';
        } else {
            manageBtn.textContent = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª';
            manageBtn.style.backgroundColor = '#d4af37';
        }
        renderFavorites();
    }

    function renderCategoryManagement() {
        const categories = Object.keys(favorites);
        categories.forEach(category => {
            const editContainer = document.createElement('div');
            editContainer.className = 'category-edit-container';
            
            const categoryInput = document.createElement('input');
            categoryInput.type = 'text';
            categoryInput.value = category;
            categoryInput.onchange = (e) => {
                renameCategory(category, e.target.value);
            };
            editContainer.appendChild(categoryInput);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'ğŸ—‘ï¸';
            deleteBtn.onclick = () => {
                if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙØ¦Ø© "${category}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù‡Ø§.`)) {
                    delete favorites[category];
                    saveFavorites();
                    renderFavorites();
                }
            };
            editContainer.appendChild(deleteBtn);

            favoritesContainer.appendChild(editContainer);
        });

        const addBtn = document.createElement('button');
        addBtn.className = 'add-category-btn';
        addBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©';
        addBtn.onclick = addNewCategory;
        favoritesContainer.appendChild(addBtn);
    }
    
    function addNewCategory() {
        const newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
        if (newName && !favorites[newName]) {
            favorites[newName] = [];
            saveFavorites();
            renderFavorites();
        } else if (newName) {
            alert("Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
        }
    }

    function renameCategory(oldName, newName) {
        if (newName && newName !== oldName && !favorites[newName]) {
            favorites[newName] = favorites[oldName];
            delete favorites[oldName];
            saveFavorites();
            renderFavorites();
        } else if (newName && newName !== oldName) {
            alert("Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.");
        }
    }

    function renderDownloads() {
      downloadsContainer.innerHTML = '';
      downloadHistory.sort((a, b) => a - b).forEach(num => {
        const btn = createDownloadButton(num);
        const name = localStorage.getItem(`channelName_${num}`) || `Ù‚Ù†Ø§Ø© ${num}`;
        const nameSpan = document.createElement('span');
        nameSpan.style.fontSize = '0.8em';
        nameSpan.style.marginRight = '6px';
        nameSpan.textContent = name;
        btn.insertBefore(nameSpan, btn.querySelector('span'));
        downloadsContainer.appendChild(btn);
      });
    }

    function clearDownloads() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§ØªØŸ')) {
            downloadHistory = [];
            saveDownloadHistory();
            renderDownloads();
        }
    }

    function deleteChannelPermanently(number) {
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù‚Ù†Ø§Ø© Ø±Ù‚Ù… ${number} Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…ØŸ`)) {
            const downloadIndex = downloadHistory.indexOf(number);
            if (downloadIndex > -1) {
                downloadHistory.splice(downloadIndex, 1);
                saveDownloadHistory();
            }
            
            for (const category in favorites) {
                const favoriteIndex = favorites[category].indexOf(number);
                if (favoriteIndex > -1) {
                    favorites[category].splice(favoriteIndex, 1);
                }
            }
            saveFavorites();

            localStorage.removeItem(`channelName_${number}`);

            renderDownloads();
            renderFavorites();
            renderAllChannels(currentPage);
        }
    }

    function downloadM3U(channelNumber) {
      const ip = document.getElementById('ip').value;
      const port = document.getElementById('port').value;
      const url = `http://${ip}:${port}/live/${channelNumber}`;
      const channelName = localStorage.getItem(`channelName_${channelNumber}`) || `Ù‚Ù†Ø§Ø© ${channelNumber}`;
      const content = `#EXTM3U\n#EXTINF:-1,${channelName}\n${url}`;
      const blob = new Blob([content], { type: 'audio/x-mpegurl' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${channelName}.m3u`;
      link.click();

      if (!downloadHistory.includes(channelNumber)) {
          downloadHistory.push(channelNumber);
          saveDownloadHistory();
          renderDownloads();
      }

      instructionMessage.style.display = 'block';
      setTimeout(() => {
        instructionMessage.style.display = 'none';
      }, 5000);
    }

    function toggleEditing() {
      editingEnabled = !editingEnabled;
      const toggleEditBtn = document.getElementById('toggleEdit');

      if (editingEnabled) {
        toggleEditBtn.textContent = 'âœ… Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚';
        toggleEditBtn.classList.add('editing');
        document.querySelectorAll('.clear-downloads-btn').forEach(btn => btn.style.display = 'none');
      } else {
        toggleEditBtn.textContent = 'âœï¸ ØªÙØ¹ÙŠÙ„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚Ù†ÙˆØ§Øª';
        toggleEditBtn.classList.remove('editing');
        document.querySelectorAll('.channel-btn.editing span.channel-name').forEach(span => {
          const channelNumber = span.parentElement.dataset.channelNumber;
          localStorage.setItem(`channelName_${channelNumber}`, span.textContent);
        });
        document.querySelectorAll('.clear-downloads-btn').forEach(btn => btn.style.display = 'block');
      }
      renderAllChannels(currentPage);
      renderFavorites();
      renderDownloads();
    }

    function renderAllChannels(page) {
      allChannelsContainer.innerHTML = '';
      const start = (page - 1) * channelsPerPage + 1;
      const end = Math.min(start + channelsPerPage - 1, maxChannels);

      for (let i = start; i <= end; i++) {
        const btn = createChannelButton(i);
        allChannelsContainer.appendChild(btn);
      }
      updatePaginationButtons();
    }

    function updatePaginationButtons() {
      document.getElementById('firstPageBtn').disabled = currentPage === 1;
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
      document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
    }

    function goToNextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        renderAllChannels(currentPage);
        filterChannels();
      }
    }

    function goToPreviousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderAllChannels(currentPage);
        filterChannels();
      }
    }

    function goToFirstPage() {
      currentPage = 1;
      renderAllChannels(currentPage);
      filterChannels();
    }

    function goToLastPage() {
      currentPage = totalPages;
      renderAllChannels(currentPage);
      filterChannels();
    }

    function filterChannels() {
        const filterText = searchInput.value.toLowerCase().trim();
        const allChannelButtons = document.querySelectorAll('#channels .channel-btn');
        const paginationContainer = document.querySelector('.pagination');

        if (filterText) {
            paginationContainer.style.display = 'none';
        } else {
            paginationContainer.style.display = 'flex';
        }

        allChannelButtons.forEach(btn => {
            const channelName = localStorage.getItem(`channelName_${btn.dataset.channelNumber}`) || `Ù‚Ù†Ø§Ø© ${btn.dataset.channelNumber}`;
            if (channelName.toLowerCase().includes(filterText) || btn.dataset.channelNumber.includes(filterText)) {
                btn.style.display = 'flex';
            } else {
                btn.style.display = 'none';
            }
        });
    }

    renderFavorites();
    renderDownloads();
    renderAllChannels(currentPage);
    searchInput.addEventListener('keyup', filterChannels);
  </script>
</body>
</html>
