<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local IPTV</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#d4af37">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f5f5, #e5e5e5);
      padding: 20px;
      text-align: center;
      direction: rtl;
    }
    h1 {
      color: #333;
      font-weight: 700;
    }
    marquee {
      font-size: 1.1em;
      color: #444;
      margin-bottom: 20px;
    }
    .input-row {
      margin: 10px auto;
      max-width: 300px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .input-row label {
      width: 35%;
      text-align: right;
      font-weight: bold;
    }
    .input-row input {
      width: 60%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: left;
      direction: ltr;
    }
    #toggleEdit {
      margin: 15px auto;
      padding: 12px 25px;
      background-color: #d4af37;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: background-color 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #toggleEdit.editing {
      background-color: #28a745;
    }
    #toggleEdit:not(.editing):hover {
      background-color: #b8912a;
    }
    .section {
      margin-top: 30px;
    }
    .section h3 {
      border-bottom: 2px solid #d4af37;
      padding-bottom: 5px;
      display: inline-block;
      font-weight: 700;
      color: #333;
    }
    #favorites-container, #channels, #downloads-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 5px;
      padding: 10px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .channel-btn {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px 8px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8em;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s, transform 0.2s;
      color: #333;
    }
    .channel-btn:hover {
      background-color: #e0e0e0;
      transform: translateY(-2px);
    }
    .channel-btn .fav-icon {
      font-size: 1em;
      cursor: pointer;
      color: #fff;
      text-shadow: 0 0 2px #555;
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
      z-index: 10;
    }
    .channel-btn.favorite .fav-icon {
      color: #dc3545;
      text-shadow: 0 0 2px #555;
    }
    .channel-btn:hover .fav-icon,
    .channel-btn.editing .fav-icon {
        display: block;
    }
    .channel-btn span.channel-number,
    .channel-btn span.channel-name {
        flex-grow: 1;
        text-align: center;
        padding: 0;
        pointer-events: none;
        user-select: none;
    }
    .channel-btn.editing {
      justify-content: flex-end;
      padding: 5px 10px;
      text-align: right;
    }
    .channel-btn.editing .fav-icon {
      position: static;
      transform: none;
      margin-left: 5px;
    }
    .channel-btn.editing span.channel-name {
        pointer-events: auto;
        user-select: text;
        text-align: right;
        border-bottom: 1px dashed #000;
        display: inline;
    }
    .channel-btn.editing span.channel-number {
        display: none;
    }
    .search-row {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    #searchInput {
      width: 70%;
      max-width: 400px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: right;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .pagination button {
      padding: 10px 15px;
      background-color: #d4af37;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: background-color 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .pagination button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .pagination button:not(:disabled):hover {
      background-color: #b8912a;
    }
    .favorites-btn, .downloads-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .favorites-btn .fav-icon {
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      display: block;
    }
    .downloads-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .clear-downloads-btn {
        margin-top: 10px;
        padding: 8px 15px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.8em;
        transition: background-color 0.3s;
    }
    .clear-downloads-btn:hover {
        background-color: #c82333;
    }
    .downloads-btn.editing .delete-icon {
        display: block;
    }
    .downloads-btn .delete-icon {
        color: #dc3545;
        font-size: 1.2em;
        cursor: pointer;
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        display: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ“º Local IPTV</h1>
  <marquee behavior="scroll" direction="right">Mahmoud Adel Saleh ğŸ–¥ï¸ Local IPTV</marquee>

  <div class="input-row">
    <label for="ip">Ø¹Ù†ÙˆØ§Ù† IP:</label>
    <input type="text" id="ip" value="192.168.1.88">
  </div>
  <div class="input-row">
    <label for="port">Ø§Ù„Ø¨ÙˆØ±Øª:</label>
    <input type="text" id="port" value="9891">
  </div>

  <div class="section" id="favorites-section">
    <h3>ğŸ“Œ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3>
    <div id="favorites-container">
      <div id="favorite-channels"></div>
    </div>
  </div>

  <div class="section" id="downloads-section">
    <h3>ğŸ“¥ ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h3>
    <div class="downloads-container">
      <div id="download-channels"></div>
      <button class="clear-downloads-btn" onclick="clearDownloads()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
    </div>
  </div>

  <div class="section" id="all-section">
    <h3>ğŸ“¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h3>
    <div class="search-row">
        <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø©...">
    </div>
    <button id="toggleEdit" onclick="toggleEditing()">âœï¸ ØªÙØ¹ÙŠÙ„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚Ù†ÙˆØ§Øª</button>
    <div class="pagination">
      <button onclick="goToFirstPage()" id="firstPageBtn">Ø§Ù„Ø£ÙˆÙ„</button>
      <button onclick="goToPreviousPage()" id="prevPageBtn">Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù¥Ù </button>
      <button onclick="goToNextPage()" id="nextPageBtn">Ø§Ù„ØªØ§Ù„ÙŠ Ù¥Ù </button>
      <button onclick="goToLastPage()" id="lastPageBtn">Ø§Ù„Ø£Ø®ÙŠØ±</button>
    </div>
    <div id="channels"></div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('Service Worker registered! Scope is:', registration.scope);
          })
          .catch(err => {
            console.log('Service Worker registration failed:', err);
          });
      });
    }

    let editingEnabled = false;
    let currentPage = 1;
    const channelsPerPage = 50;
    const maxChannels = 2000;
    const totalPages = Math.ceil(maxChannels / channelsPerPage);
    let favoriteNumbers = JSON.parse(localStorage.getItem('favoriteNumbers')) || [];
    let downloadHistory = JSON.parse(localStorage.getItem('downloadHistory')) || [];

    const favoritesContainer = document.getElementById('favorite-channels');
    const allChannelsContainer = document.getElementById('channels');
    const searchInput = document.getElementById('searchInput');
    const downloadsContainer = document.getElementById('download-channels');

    function createChannelButton(number) {
      const btn = document.createElement('div');
      btn.className = 'channel-btn';
      btn.dataset.channelNumber = number;

      const favIcon = document.createElement('span');
      favIcon.className = 'fav-icon';
      favIcon.innerHTML = 'ğŸ¤';
      favIcon.onclick = (e) => {
        e.stopPropagation();
        toggleFavorite(number, btn);
      };

      const channelNumberSpan = document.createElement('span');
      channelNumberSpan.className = 'channel-number';
      channelNumberSpan.textContent = number;

      const channelNameSpan = document.createElement('span');
      channelNameSpan.className = 'channel-name';
      const channelName = localStorage.getItem(`channelName_${number}`) || `Ù‚Ù†Ø§Ø© ${number}`;
      channelNameSpan.textContent = channelName;
      channelNameSpan.contentEditable = editingEnabled;

      btn.appendChild(favIcon);
      if (editingEnabled) {
          btn.classList.add('editing');
          btn.appendChild(channelNameSpan);
      } else {
          btn.appendChild(channelNumberSpan);
      }

      btn.onclick = () => {
        if (!editingEnabled) {
          downloadM3U(number);
        }
      };

      if (favoriteNumbers.includes(number)) {
        btn.classList.add('favorite');
        favIcon.innerHTML = 'â¤ï¸';
      }

      return btn;
    }
    
    function createFavoriteButton(number) {
        const btn = document.createElement('div');
        btn.className = 'channel-btn favorites-btn';
        btn.dataset.channelNumber = number;

        const favIcon = document.createElement('span');
        favIcon.className = 'fav-icon';
        favIcon.innerHTML = 'â¤ï¸';
        favIcon.onclick = (e) => {
            e.stopPropagation();
            toggleFavorite(number, btn);
        };
        btn.appendChild(favIcon);

        const channelNumberSpan = document.createElement('span');
        channelNumberSpan.textContent = number;
        btn.appendChild(channelNumberSpan);
        
        btn.onclick = () => {
          downloadM3U(number);
        };
        return btn;
    }
    
    function createDownloadButton(number) {
        const btn = document.createElement('div');
        btn.className = 'channel-btn downloads-btn';
        btn.dataset.channelNumber = number;

        const channelNumberSpan = document.createElement('span');
        channelNumberSpan.textContent = number;
        btn.appendChild(channelNumberSpan);

        if (editingEnabled) {
            btn.classList.add('editing');
            const deleteIcon = document.createElement('span');
            deleteIcon.className = 'delete-icon';
            deleteIcon.innerHTML = 'ğŸ—‘ï¸';
            deleteIcon.onclick = (e) => {
                e.stopPropagation();
                deleteChannelPermanently(number);
            };
            btn.appendChild(deleteIcon);
        }
        
        btn.onclick = () => {
            if (!editingEnabled) {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØªØ­ Ø§Ù„Ù‚Ù†Ø§Ø© Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ ÙÙŠ VLCØŸ\n\n(Ø§Ø¶ØºØ· "Ø¥Ù„ØºØ§Ø¡" Ù„ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù‚Ù†Ø§Ø©)')) {
                    openInVLC(number);
                } else {
                    downloadM3U(number);
                }
            }
        };
        return btn;
    }

    function toggleFavorite(number, btn) {
      if (editingEnabled) return;

      const index = favoriteNumbers.indexOf(number);
      if (index > -1) {
        favoriteNumbers.splice(index, 1);
        btn.classList.remove('favorite');
        if (btn.querySelector('.fav-icon')) {
          btn.querySelector('.fav-icon').innerHTML = 'ğŸ¤';
        }
      } else {
        favoriteNumbers.push(number);
        btn.classList.add('favorite');
        if (btn.querySelector('.fav-icon')) {
          btn.querySelector('.fav-icon').innerHTML = 'â¤ï¸';
        }
      }
      saveFavorites();
      renderFavorites();
    }

    function saveFavorites() {
      localStorage.setItem('favoriteNumbers', JSON.stringify(favoriteNumbers));
    }
    
    function saveDownloadHistory() {
      localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
    }

    function renderFavorites() {
      favoritesContainer.innerHTML = '';
      favoriteNumbers.sort((a, b) => a - b).forEach(num => {
        const btn = createFavoriteButton(num);
        favoritesContainer.appendChild(btn);
      });
    }
    
    function renderDownloads() {
      downloadsContainer.innerHTML = '';
      downloadHistory.sort((a, b) => a - b).forEach(num => {
        const btn = createDownloadButton(num);
        downloadsContainer.appendChild(btn);
      });
    }
    
    function clearDownloads() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§ØªØŸ')) {
            downloadHistory = [];
            saveDownloadHistory();
            renderDownloads();
        }
    }

    function deleteChannelPermanently(number) {
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù‚Ù†Ø§Ø© Ø±Ù‚Ù… ${number} Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…ØŸ`)) {
            // Remove from download history
            const downloadIndex = downloadHistory.indexOf(number);
            if (downloadIndex > -1) {
                downloadHistory.splice(downloadIndex, 1);
                saveDownloadHistory();
            }

            // Remove from favorites
            const favoriteIndex = favoriteNumbers.indexOf(number);
            if (favoriteIndex > -1) {
                favoriteNumbers.splice(favoriteIndex, 1);
                saveFavorites();
            }

            // Remove custom name from localStorage
            localStorage.removeItem(`channelName_${number}`);

            // Re-render all sections
            renderDownloads();
            renderFavorites();
            renderAllChannels(currentPage);
        }
    }

    function downloadM3U(channelNumber) {
      const ip = document.getElementById('ip').value;
      const port = document.getElementById('port').value;
      const url = `http://${ip}:${port}/live/${channelNumber}`;
      const channelName = localStorage.getItem(`channelName_${channelNumber}`) || `Ù‚Ù†Ø§Ø© ${channelNumber}`;
      const content = `#EXTM3U\n#EXTINF:-1,${channelName}\n${url}`;
      const blob = new Blob([content], { type: 'audio/x-mpegurl' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${channelName}.m3u`;
      link.click();
      
      if (!downloadHistory.includes(channelNumber)) {
          downloadHistory.push(channelNumber);
          saveDownloadHistory();
          renderDownloads();
      }
    }

    function openInVLC(channelNumber) {
        const ip = document.getElementById('ip').value;
        const port = document.getElementById('port').value;
        const url = `http://${ip}:${port}/live/${channelNumber}`;
        window.location.href = `vlc://${url}`;
    }

    function toggleEditing() {
      editingEnabled = !editingEnabled;
      const toggleEditBtn = document.getElementById('toggleEdit');
      
      if (editingEnabled) {
        toggleEditBtn.textContent = 'âœ… Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚';
        toggleEditBtn.classList.add('editing');
        document.querySelectorAll('.clear-downloads-btn').forEach(btn => btn.style.display = 'none');
      } else {
        toggleEditBtn.textContent = 'âœï¸ ØªÙØ¹ÙŠÙ„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚Ù†ÙˆØ§Øª';
        toggleEditBtn.classList.remove('editing');
        document.querySelectorAll('.channel-btn.editing span.channel-name').forEach(span => {
          const channelNumber = span.parentElement.dataset.channelNumber;
          localStorage.setItem(`channelName_${channelNumber}`, span.textContent);
        });
        document.querySelectorAll('.clear-downloads-btn').forEach(btn => btn.style.display = 'block');
      }
      renderAllChannels(currentPage);
      renderFavorites();
      renderDownloads();
    }

    function renderAllChannels(page) {
      allChannelsContainer.innerHTML = '';
      const start = (page - 1) * channelsPerPage + 1;
      const end = Math.min(start + channelsPerPage - 1, maxChannels);

      for (let i = start; i <= end; i++) {
        const btn = createChannelButton(i);
        allChannelsContainer.appendChild(btn);
      }
      updatePaginationButtons();
    }

    function updatePaginationButtons() {
      document.getElementById('firstPageBtn').disabled = currentPage === 1;
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
      document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
    }

    function goToNextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        renderAllChannels(currentPage);
        filterChannels();
      }
    }

    function goToPreviousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderAllChannels(currentPage);
        filterChannels();
      }
    }

    function goToFirstPage() {
      currentPage = 1;
      renderAllChannels(currentPage);
      filterChannels();
    }

    function goToLastPage() {
      currentPage = totalPages;
      renderAllChannels(currentPage);
      filterChannels();
    }

    function filterChannels() {
        const filterText = searchInput.value.toLowerCase().trim();
        const allChannelButtons = document.querySelectorAll('#channels .channel-btn');
        const paginationContainer = document.querySelector('.pagination');

        if (filterText) {
            paginationContainer.style.display = 'none';
        } else {
            paginationContainer.style.display = 'flex';
        }

        allChannelButtons.forEach(btn => {
            const channelName = localStorage.getItem(`channelName_${btn.dataset.channelNumber}`) || `Ù‚Ù†Ø§Ø© ${btn.dataset.channelNumber}`;
            if (channelName.toLowerCase().includes(filterText) || btn.dataset.channelNumber.includes(filterText)) {
                btn.style.display = 'flex';
            } else {
                btn.style.display = 'none';
            }
        });
    }

    renderFavorites();
    renderDownloads();
    renderAllChannels(currentPage);
    searchInput.addEventListener('keyup', filterChannels);
  </script>
</body>
</html>
